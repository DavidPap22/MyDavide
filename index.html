<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>MYDAVIDE 8.0</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- SYSTEM VARIABLES --- */
        :root {
            /* Palette Richiesta */
            --col-fin: #10b981;   /* Verde */
            --col-cal: #2563eb;   /* Blu */
            --col-task: #ef4444;  /* Rosso */
            
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --col-text: #0f172a;
            --col-soft: #64748b;
            --nav-bg: rgba(255, 255, 255, 0.95);
            
            --radius: 24px;
            --nav-h: 85px;
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.08);
            
            /* Transitions */
            --trans: background 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        /* Dark Mode Optimized */
        [data-theme="dark"] {
            --bg-body: #0f1115;
            --bg-card: #1e222b;
            --col-text: #f1f5f9;
            --col-soft: #94a3b8;
            --nav-bg: rgba(30, 34, 43, 0.95);
            --shadow: 0 10px 40px -10px rgba(0,0,0,0.6);
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family:'DM Sans', sans-serif; -webkit-tap-highlight-color:transparent; }
        body { background:var(--bg-body); color:var(--col-text); height:100vh; overflow:hidden; transition: var(--trans); }

        /* --- LAYOUT --- */
        .view { 
            position:absolute; top:0; left:0; width:100%; height:100%; 
            padding:20px 20px calc(var(--nav-h) + 20px) 20px; 
            overflow-y:auto; display:none; opacity:0; transform:scale(0.98); 
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .view.active { display:block; opacity:1; transform:scale(1); }
        .view::-webkit-scrollbar { display:none; }

        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-top:10px; }
        .title { font-size:1.8rem; font-weight:800; letter-spacing:-1px; }
        .btn-icon { 
            width:42px; height:42px; background:var(--bg-card); border-radius:50%; 
            display:grid; place-items:center; box-shadow:var(--shadow); cursor:pointer; 
            color:var(--col-text); transition: var(--trans);
        }

        /* WIDGET CARD STYLE */
        .widget { 
            background:var(--bg-card); border-radius:var(--radius); padding:20px; 
            margin-bottom:15px; box-shadow:var(--shadow); position:relative; overflow:hidden;
            transition: var(--trans);
        }
        .widget-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .widget-title { font-weight:700; display:flex; align-items:center; gap:8px; }

        /* --- HOME --- */
        .smart-banner {
            background: linear-gradient(135deg, var(--col-cal), #60a5fa); color: white;
            padding: 25px; border-radius: var(--radius); min-height: 120px;
            display: flex; flex-direction: column; justify-content: center; position: relative;
            cursor: pointer; overflow: hidden; box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.4);
        }
        
        /* Water */
        .water-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 15px 0; }
        .glass {
            height: 45px; background: var(--bg-body); border-radius: 8px 8px 15px 15px;
            position: relative; overflow: hidden; cursor: pointer; border: 2px solid rgba(0,0,0,0.05);
        }
        .glass::after {
            content:''; position: absolute; bottom:0; left:0; width:100%; height:0%;
            background: #3b82f6; transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .glass.full::after { height: 100%; }

        /* --- AGENDA & CALENDAR --- */
        .cal-controls { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; background:var(--bg-card); padding:5px; border-radius:15px; }
        .cal-month-title { font-weight:bold; color:var(--col-cal); }
        
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .day-cell { 
            aspect-ratio:1; border-radius: 12px; font-size: 0.85rem; 
            padding: 2px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content:center;
            border: 1px solid transparent; position: relative;
        }
        .day-cell.today { background: var(--col-cal); color: white; font-weight: bold; }
        .day-cell.selected { border: 2px solid var(--col-cal); }
        .dots-row { display:flex; gap:3px; margin-top:2px; }
        .dot { width:5px; height:5px; border-radius:50%; }

        /* --- FINANCE WIDGETS --- */
        .fin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .big-balance { font-size: 2.5rem; font-weight: 900; color: var(--col-fin); letter-spacing: -1px; }

        /* --- NAV BOTTOM --- */
        .nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-h); 
            background: var(--nav-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid rgba(0,0,0,0.05); z-index: 100; padding: 0 15px;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; gap: 5px; 
            font-size: 0.65rem; color: var(--col-soft); cursor: pointer; width: 60px;
            transition: 0.2s;
        }
        .nav-item i { font-size: 1.4rem; margin-bottom:2px; }
        .nav-item.active { color: var(--col-text); font-weight: 800; transform: translateY(-2px); }
        
        /* Home Center Button */
        .nav-home { 
            width: 65px; height: 65px; background: var(--col-text); border-radius: 50%; 
            color: var(--bg-body); display: grid; place-items: center; font-size: 1.8rem; 
            transform: translateY(-25px); border: 6px solid var(--bg-body); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); transition: 0.2s;
        }
        .nav-home:active { transform: translateY(-20px) scale(0.95); }

        /* --- MODALS & SELECTORS --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 200; display: none; align-items: flex-end; }
        .sheet { background: var(--bg-card); width: 100%; border-radius: 30px 30px 0 0; padding: 30px 20px 40px 20px; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        input, select { 
            width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 16px; 
            border: 1px solid rgba(0,0,0,0.1); background: var(--bg-body); 
            color: var(--col-text); font-size:1rem; outline:none;
        }
        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: bold; color: white; cursor: pointer; font-size:1rem; }

        /* Multi Select Buttons */
        .multi-select-row { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; display: none; }
        .ms-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--col-soft);
            display: grid; place-items: center; font-size: 0.8rem; color: var(--col-soft); cursor: pointer;
        }
        .ms-btn.active { background: var(--col-text); color: var(--bg-body); border-color: var(--col-text); font-weight: bold; }
        
        .fab { position: fixed; bottom: 110px; right: 20px; width: 55px; height: 55px; border-radius: 50%; display: grid; place-items: center; color: white; font-size: 1.4rem; box-shadow: 0 8px 20px rgba(0,0,0,0.25); z-index: 90; cursor: pointer; }

    </style>
</head>
<body data-theme="light">

    <!-- 1. HOME VIEW -->
    <div id="view-home" class="view active">
        <div class="header">
            <div class="title">MyDavide</div>
            <div class="btn-icon" onclick="toggleTheme()"><i class="fas fa-moon"></i></div>
        </div>

        <!-- Smart Banner: Link to Calendar -->
        <div class="smart-banner" onclick="navTo('cal')">
            <div id="banner-content">
                <div style="opacity:0.8; font-size:0.9rem; margin-bottom:5px" id="banner-sub">OGGI</div>
                <h2 id="banner-main">Caricamento...</h2>
                <div style="font-size:0.9rem; margin-top:5px" id="banner-extra">...</div>
            </div>
            <div style="position:absolute; bottom:15px; right:15px; font-size:2rem; opacity:0.2"><i class="fas fa-calendar-alt"></i></div>
        </div>

        <!-- Widget: Portafoglio -->
        <div class="widget" onclick="navTo('fin')">
            <div class="widget-head">
                <div class="widget-title" style="color:var(--col-fin)"><i class="fas fa-wallet"></i> PORTAFOGLIO</div>
                <i class="fas fa-chevron-right" style="opacity:0.3"></i>
            </div>
            <div class="big-balance" id="home-bal">â‚¬0.00</div>
            <div style="height:100px; width:100%; margin-top:10px;">
                <canvas id="homeFinChart"></canvas>
            </div>
        </div>

        <!-- Widget: Idratazione -->
        <div class="widget">
            <div class="widget-head">
                <div class="widget-title" style="color:#3b82f6"><i class="fas fa-tint"></i> IDRATAZIONE</div>
                <span style="font-weight:bold" id="water-text">0/8</span>
            </div>
            <div class="water-grid" id="water-grid"></div>
            <div style="height:6px; background:rgba(0,0,0,0.05); border-radius:3px; overflow:hidden">
                <div id="water-bar" style="height:100%; width:0%; background:#3b82f6; transition:width 0.3s"></div>
            </div>
        </div>

        <!-- Widget: AttivitÃ  -->
        <div class="widget" onclick="navTo('todo')">
            <div class="widget-head">
                <div class="widget-title" style="color:var(--col-task)"><i class="fas fa-check-circle"></i> ATTIVITÃ€</div>
                <span id="task-pct">0%</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px">
                <div style="width:80px; height:80px"><canvas id="homeTaskChart"></canvas></div>
                <div style="flex:1; font-size:0.9rem; color:var(--col-soft)" id="home-task-desc">
                    Nessun task in sospeso.
                </div>
            </div>
        </div>
    </div>

    <!-- 2. CALENDAR VIEW -->
    <div id="view-cal" class="view">
        <div class="header"><div class="title">Agenda</div> <div class="btn-icon" onclick="setToday()"><i class="fas fa-calendar-day"></i></div></div>
        
        <div class="widget">
            <div class="cal-controls">
                <i class="fas fa-chevron-left" onclick="changeMonth(-1)" style="padding:10px; cursor:pointer"></i>
                <div class="cal-month-title" id="cal-month-label">...</div>
                <i class="fas fa-chevron-right" onclick="changeMonth(1)" style="padding:10px; cursor:pointer"></i>
            </div>
            
            <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:0.7rem; color:var(--col-soft); margin-bottom:5px">
                <div>L</div><div>M</div><div>M</div><div>G</div><div>V</div><div>S</div><div>D</div>
            </div>
            <div id="cal-grid" class="month-grid"></div>
        </div>

        <h4 style="margin:20px 0 10px 5px">Impegni del Giorno</h4>
        <div id="cal-day-list" style="padding-bottom:80px"></div>

        <div class="fab" style="background:var(--col-cal)" onclick="openModal('modal-evt')"><i class="fas fa-plus"></i></div>
    </div>

    <!-- 3. FINANCE VIEW -->
    <div id="view-fin" class="view">
        <div class="header"><div class="title">Portafoglio</div></div>

        <!-- 4 Widgets Grid -->
        <div class="fin-grid">
            <div class="widget" style="margin:0; padding:15px">
                <small style="color:var(--col-soft)">Saldo</small>
                <div style="font-size:1.4rem; font-weight:bold; color:var(--col-fin)" id="fin-bal-w">â‚¬0</div>
            </div>
            <div class="widget" style="margin:0; padding:15px">
                <small style="color:var(--col-soft)">Mensile</small>
                <div style="font-size:1.4rem; font-weight:bold" id="fin-month-w">â‚¬0</div>
            </div>
            <div class="widget" style="grid-column:span 2; height:200px">
                <small style="color:var(--col-soft)">Entrate vs Uscite</small>
                <div style="width:100%; height:150px"><canvas id="finBarChart"></canvas></div>
            </div>
            <div class="widget" style="grid-column:span 2; height:200px">
                <small style="color:var(--col-soft)">Andamento Annuale</small>
                <div style="width:100%; height:150px"><canvas id="finLineChart"></canvas></div>
            </div>
        </div>
        
        <h4 style="margin:20px 0 10px 5px">Cronologia</h4>
        <div id="fin-list" style="padding-bottom:80px"></div>

        <div class="fab" style="background:var(--col-fin)" onclick="openModal('modal-fin')"><i class="fas fa-plus"></i></div>
    </div>

    <!-- 4. TASKS VIEW -->
    <div id="view-todo" class="view">
        <div class="header">
            <div class="title">Task & Liste</div>
            <div class="btn-icon" onclick="openModal('modal-list')"><i class="fas fa-folder-plus"></i></div>
        </div>

        <div id="todo-container" style="padding-bottom:80px"></div>

        <div class="fab" style="background:var(--col-task)" onclick="openModal('modal-task')"><i class="fas fa-plus"></i></div>
    </div>

    <!-- 5. PROFILE / SETTINGS -->
    <div id="view-set" class="view">
        <div class="header"><div class="title">Profilo</div></div>
        
        <div class="widget">
            <h4>Impostazioni Utente</h4>
            <input type="text" id="user-name" placeholder="Il tuo nome" onchange="saveSet()" style="margin-top:10px">
            <label>API Key (Opzionale per AI)</label>
            <input type="password" id="user-key" onchange="saveSet()">
        </div>

        <div class="widget">
            <h4>Gestione Dati</h4>
            <button class="btn" style="background:var(--col-cal); margin-top:10px" onclick="exportData()">ðŸ’¾ Scarica Backup</button>
            <div style="margin-top:10px; position:relative">
                <button class="btn" style="background:var(--col-text)">ðŸ“‚ Carica Backup</button>
                <input type="file" onchange="importData(this)" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer">
            </div>
            <button class="btn" style="background:var(--col-task); margin-top:10px" onclick="resetApp()">âš  Reset Totale</button>
        </div>
    </div>

    <!-- NAVIGATION BAR -->
    <nav class="nav">
        <div class="nav-item" onclick="navTo('cal')" id="n-cal"><i class="fas fa-calendar-alt"></i>Agenda</div>
        <div class="nav-item" onclick="navTo('fin')" id="n-fin"><i class="fas fa-wallet"></i>Soldi</div>
        
        <div class="nav-home" onclick="navTo('home')"><i class="fas fa-home"></i></div>

        <div class="nav-item" onclick="navTo('todo')" id="n-todo"><i class="fas fa-check-square"></i>Task</div>
        <div class="nav-item" onclick="navTo('set')" id="n-set"><i class="fas fa-user-circle"></i>Profilo</div>
    </nav>

    <!-- MODALS -->

    <!-- Modal EVENTO -->
    <div id="modal-evt" class="modal" onclick="closeModal(event, 'modal-evt')">
        <div class="sheet">
            <h3 style="color:var(--col-cal)">Nuovo Evento</h3>
            <input type="text" id="evt-title" placeholder="Titolo">
            <div style="display:flex; gap:10px">
                <div style="flex:1"><label>Inizio</label><input type="time" id="evt-start"></div>
                <div style="flex:1"><label>Fine</label><input type="time" id="evt-end"></div>
            </div>
            <label>Data</label><input type="date" id="evt-date">
            
            <label>Ricorrenza</label>
            <select id="evt-recur" onchange="toggleRecurOptions('evt', this.value)">
                <option value="none">Singola</option>
                <option value="weekly">Giorni Settimana</option>
                <option value="monthly">Mesi Specifici</option>
            </select>
            
            <div id="evt-days" class="multi-select-row">
                <!-- Days 1-7 -->
                <div class="ms-btn" onclick="togBtn(this,1)">L</div><div class="ms-btn" onclick="togBtn(this,2)">M</div>
                <div class="ms-btn" onclick="togBtn(this,3)">M</div><div class="ms-btn" onclick="togBtn(this,4)">G</div>
                <div class="ms-btn" onclick="togBtn(this,5)">V</div><div class="ms-btn" onclick="togBtn(this,6)">S</div>
                <div class="ms-btn" onclick="togBtn(this,0)">D</div>
            </div>
            <div id="evt-months" class="multi-select-row">
                <!-- Months 0-11 -->
                <div class="ms-btn" onclick="togBtn(this,0)">Gen</div><div class="ms-btn" onclick="togBtn(this,1)">Feb</div>
                <div class="ms-btn" onclick="togBtn(this,2)">Mar</div><div class="ms-btn" onclick="togBtn(this,3)">Apr</div>
                <div class="ms-btn" onclick="togBtn(this,4)">Mag</div><div class="ms-btn" onclick="togBtn(this,5)">Giu</div>
                <div class="ms-btn" onclick="togBtn(this,6)">Lug</div><div class="ms-btn" onclick="togBtn(this,7)">Ago</div>
                <div class="ms-btn" onclick="togBtn(this,8)">Set</div><div class="ms-btn" onclick="togBtn(this,9)">Ott</div>
                <div class="ms-btn" onclick="togBtn(this,10)">Nov</div><div class="ms-btn" onclick="togBtn(this,11)">Dic</div>
            </div>

            <button class="btn" style="background:var(--col-cal)" onclick="saveEvt()">Salva</button>
        </div>
    </div>

    <!-- Modal FINANCE -->
    <div id="modal-fin" class="modal" onclick="closeModal(event, 'modal-fin')">
        <div class="sheet">
            <h3 style="color:var(--col-fin)">Transazione</h3>
            <input type="text" id="fin-desc" placeholder="Descrizione">
            <input type="number" id="fin-amt" placeholder="Importo (- per uscite)">
            <label>Data</label><input type="date" id="fin-date">
            
            <label>Ricorrenza</label>
            <select id="fin-recur" onchange="toggleRecurOptions('fin', this.value)">
                <option value="none">Singola</option>
                <option value="monthly">Ogni Mese (Giorno fisso)</option>
                <option value="custom_months">Mesi Specifici</option>
            </select>
            
            <div id="fin-months" class="multi-select-row">
                 <div class="ms-btn" onclick="togBtn(this,0)">G</div><div class="ms-btn" onclick="togBtn(this,1)">F</div>
                 <div class="ms-btn" onclick="togBtn(this,2)">M</div><div class="ms-btn" onclick="togBtn(this,3)">A</div>
                 <div class="ms-btn" onclick="togBtn(this,4)">M</div><div class="ms-btn" onclick="togBtn(this,5)">G</div>
                 <div class="ms-btn" onclick="togBtn(this,6)">L</div><div class="ms-btn" onclick="togBtn(this,7)">A</div>
                 <div class="ms-btn" onclick="togBtn(this,8)">S</div><div class="ms-btn" onclick="togBtn(this,9)">O</div>
                 <div class="ms-btn" onclick="togBtn(this,10)">N</div><div class="ms-btn" onclick="togBtn(this,11)">D</div>
            </div>

            <button class="btn" style="background:var(--col-fin)" onclick="saveFin()">Registra</button>
        </div>
    </div>

    <!-- Modal TASK -->
    <div id="modal-task" class="modal" onclick="closeModal(event, 'modal-task')">
        <div class="sheet">
            <h3 style="color:var(--col-task)">AttivitÃ </h3>
            <input id="task-title" placeholder="Cosa devi fare?">
            <label>Lista</label>
            <select id="task-list-sel"></select>
            <label>Data (Opzionale)</label>
            <input type="date" id="task-date">
            
            <label>Ricorrenza</label>
            <select id="task-recur" onchange="toggleRecurOptions('task', this.value)">
                <option value="none">Nessuna</option>
                <option value="weekly">Giorni Settimana</option>
            </select>
            
            <div id="task-days" class="multi-select-row">
                <div class="ms-btn" onclick="togBtn(this,1)">L</div><div class="ms-btn" onclick="togBtn(this,2)">M</div>
                <div class="ms-btn" onclick="togBtn(this,3)">M</div><div class="ms-btn" onclick="togBtn(this,4)">G</div>
                <div class="ms-btn" onclick="togBtn(this,5)">V</div><div class="ms-btn" onclick="togBtn(this,6)">S</div>
                <div class="ms-btn" onclick="togBtn(this,0)">D</div>
            </div>
            
            <button class="btn" style="background:var(--col-task)" onclick="saveTask()">Aggiungi</button>
        </div>
    </div>

    <!-- Modal NEW LIST -->
    <div id="modal-list" class="modal" onclick="closeModal(event, 'modal-list')">
        <div class="sheet">
            <h3>Nuova Lista</h3>
            <input id="list-name" placeholder="Nome Lista">
            <input type="color" id="list-col" value="#ef4444" style="height:50px">
            <button class="btn" style="background:var(--col-text)" onclick="saveList()">Crea</button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        const defaultDB = {
            events: [], // {id, title, date, start, end, recurType, recurVals:[]}
            finance: [], // {id, desc, amt, date, recurType, recurVals:[]}
            lists: [{id:'l1', name:'Generale', col:'#ef4444'}],
            tasks: [], // {id, title, listId, date, done, recurType, recurVals:[]}
            water: {count:0, date:''},
            settings: {name:'Davide', theme:'light', aiKey:''}
        };
        let db = JSON.parse(localStorage.getItem('MyDavide8')) || defaultDB;
        
        let curDate = new Date(); // Calendar view date
        let selDate = new Date(); // Selected day
        let charts = {};
        
        // Saint Database (Simple)
        const saints = {
            "1-1":"Maria Madre di Dio", "19-3":"San Giuseppe", "29-6":"Pietro e Paolo", "15-8":"Assunzione",
            "1-11":"Tutti i Santi", "25-12":"Natale", "26-12":"Santo Stefano"
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check day change
            const today = new Date().toISOString().split('T')[0];
            if(db.water.date !== today) { db.water.count=0; db.water.date=today; saveDB(); }
            
            // Apply Theme
            document.body.setAttribute('data-theme', db.settings.theme);
            document.getElementById('user-name').value = db.settings.name;
            document.getElementById('user-key').value = db.settings.aiKey || '';

            // Pre-fill dates
            document.querySelectorAll('input[type="date"]').forEach(i => i.valueAsDate = new Date());

            updateBanner();
            renderAll();
        });

        function saveDB() { localStorage.setItem('MyDavide8', JSON.stringify(db)); }
        function renderAll() {
            renderHome();
            renderCal();
            renderFin();
            renderTodo();
        }

        // --- NAVIGATION ---
        function navTo(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(id !== 'home') document.getElementById('n-'+id).classList.add('active');
            
            if(id==='home') { renderHome(); }
            if(id==='cal') { renderCal(); }
            if(id==='fin') { renderFin(); }
            if(id==='todo') { renderTodo(); }
        }

        // --- HOME LOGIC ---
        function updateBanner() {
            const today = new Date();
            const dateStr = today.getDate()+'-'+(today.getMonth()+1);
            const saint = saints[dateStr] || "San del Giorno";
            
            document.getElementById('banner-sub').innerText = today.toLocaleDateString('it-IT', {weekday:'long', day:'numeric', month:'long'}).toUpperCase();
            document.getElementById('banner-main').innerText = saint;
            
            // Next event
            const next = getAllEventsForDay(today).sort((a,b)=>a.time.localeCompare(b.time))[0];
            document.getElementById('banner-extra').innerText = next ? `Prossimo: ${next.title} (${next.time})` : "Nessun impegno imminente";
        }

        function renderHome() {
            // Water
            const wg = document.getElementById('water-grid');
            wg.innerHTML = '';
            for(let i=0; i<8; i++) {
                const g = document.createElement('div');
                g.className = `glass ${i<db.water.count?'full':''}`;
                g.onclick = () => {
                    db.water.count = (i < db.water.count) ? i : i+1;
                    saveDB(); 
                    document.getElementById('water-text').innerText = `${db.water.count}/8`;
                    renderHome();
                };
                wg.appendChild(g);
            }
            document.getElementById('water-text').innerText = `${db.water.count}/8`;
            document.getElementById('water-bar').style.width = `${(db.water.count/8)*100}%`;

            // Balance
            const bal = db.finance.reduce((a,b)=>a+b.amt,0);
            document.getElementById('home-bal').innerText = `â‚¬${bal.toFixed(2)}`;

            // Task Pct
            const tot = db.tasks.length;
            const done = db.tasks.filter(t=>t.done).length;
            const pct = tot===0?100:Math.round((done/tot)*100);
            document.getElementById('task-pct').innerText = `${pct}%`;
            document.getElementById('home-task-desc').innerText = pct===100 ? "Tutto completato!" : `${tot-done} attivitÃ  rimanenti.`;

            // Home Charts
            renderHomeCharts(bal, done, tot-done);
        }

        function renderHomeCharts(bal, done, notDone) {
            // Finance Line (Simple Mock Trend based on balance history)
            const ctxF = document.getElementById('homeFinChart').getContext('2d');
            if(charts.hf) charts.hf.destroy();
            // Create data points
            let run = 0;
            const dataF = db.finance.slice(-10).map(f=>{ run+=f.amt; return run; });
            charts.hf = new Chart(ctxF, {
                type:'line',
                data: { labels:dataF.map((_,i)=>i), datasets:[{data:dataF, borderColor:'#10b981', borderWidth:2, pointRadius:0, tension:0.4}] },
                options:{plugins:{legend:false}, scales:{x:{display:false}, y:{display:false}}, maintainAspectRatio:false}
            });

            // Task Pie
            const ctxT = document.getElementById('homeTaskChart').getContext('2d');
            if(charts.ht) charts.ht.destroy();
            charts.ht = new Chart(ctxT, {
                type:'doughnut',
                data:{labels:['Fatti','Da Fare'], datasets:[{data:[done,notDone], backgroundColor:['#10b981','#ef4444'], borderWidth:0}]},
                options:{plugins:{legend:false}, maintainAspectRatio:false, cutout:'70%'}
            });
        }

        // --- AGENDA LOGIC (THE MASTER HUB) ---
        function setToday() { curDate=new Date(); selDate=new Date(); renderCal(); }
        function changeMonth(d) { curDate.setMonth(curDate.getMonth()+d); renderCal(); }

        // Core Function: Aggregate Everything
        function getAllEventsForDay(date) {
            const dStr = date.toISOString().split('T')[0];
            const dayIdx = date.getDay(); 
            const monthIdx = date.getMonth();
            const dom = date.getDate(); // day of month

            let items = [];

            // 1. Events
            db.events.forEach(e => {
                let match = false;
                if(e.recurType === 'none' && e.date === dStr) match=true;
                if(e.recurType === 'weekly' && e.recurVals.includes(dayIdx)) match=true;
                if(e.recurType === 'monthly' && e.recurVals.includes(monthIdx) && new Date(e.date).getDate() === dom) match=true;
                
                if(match) items.push({type:'evt', title:e.title, time:e.start, color:'var(--col-cal)', id:e.id});
            });

            // 2. Tasks (with date or recurrence)
            db.tasks.forEach(t => {
                let match = false;
                if(t.recurType === 'none' && t.date === dStr) match=true;
                if(t.recurType === 'weekly' && t.recurVals.includes(dayIdx)) match=true;
                
                if(match) items.push({type:'task', title:t.title, time:'--', color:'var(--col-task)', id:t.id, done:t.done});
            });

            // 3. Finance (Recurring or dated)
            db.finance.forEach(f => {
                let match = false;
                if(f.recurType === 'none' && f.date === dStr) match=true;
                if(f.recurType === 'monthly' && new Date(f.date).getDate() === dom) match=true;
                if(f.recurType === 'custom_months' && f.recurVals.includes(monthIdx) && new Date(f.date).getDate() === dom) match=true;

                if(match) items.push({type:'fin', title:`${f.desc} (â‚¬${f.amt})`, time:'--', color:'var(--col-fin)', id:f.id});
            });

            return items;
        }

        function renderCal() {
            const grid = document.getElementById('cal-grid');
            grid.innerHTML = '';
            document.getElementById('cal-month-label').innerText = curDate.toLocaleString('it-IT',{month:'long', year:'numeric'}).toUpperCase();

            const dim = new Date(curDate.getFullYear(), curDate.getMonth()+1, 0).getDate();
            const fDay = new Date(curDate.getFullYear(), curDate.getMonth(), 1).getDay();
            const pad = fDay===0?6:fDay-1;

            for(let i=0; i<pad; i++) grid.appendChild(document.createElement('div'));

            for(let i=1; i<=dim; i++) {
                const cell = document.createElement('div');
                const loopD = new Date(curDate.getFullYear(), curDate.getMonth(), i);
                const isToday = loopD.toISOString().split('T')[0] === new Date().toISOString().split('T')[0];
                const isSel = loopD.toISOString().split('T')[0] === selDate.toISOString().split('T')[0];
                
                cell.className = `day-cell ${isToday?'today':''} ${isSel?'selected':''}`;
                cell.innerHTML = `<span>${i}</span>`;
                
                // Dots
                const items = getAllEventsForDay(loopD);
                if(items.length > 0) {
                    const dr = document.createElement('div'); dr.className='dots-row';
                    // Show max 3 dots colors
                    const types = [...new Set(items.map(x=>x.color))].slice(0,3);
                    types.forEach(c => {
                        dr.innerHTML += `<div class="dot" style="background:${c}"></div>`;
                    });
                    cell.appendChild(dr);
                }

                cell.onclick = () => { selDate = loopD; renderCal(); };
                grid.appendChild(cell);
            }
            renderDayList();
        }

        function renderDayList() {
            const l = document.getElementById('cal-day-list');
            l.innerHTML = '';
            const items = getAllEventsForDay(selDate);
            
            if(items.length===0) l.innerHTML = `<p style="text-align:center; color:var(--col-soft); padding:20px">Nessun impegno.</p>`;

            items.sort((a,b) => (a.time === '--' ? '24:00' : a.time).localeCompare(b.time === '--' ? '24:00' : b.time));

            items.forEach(i => {
                const row = document.createElement('div');
                row.style.display='flex'; row.style.alignItems='center'; row.style.padding='15px'; row.style.background='var(--bg-card)'; row.style.marginBottom='10px'; row.style.borderRadius='15px'; row.style.borderLeft=`5px solid ${i.color}`;
                row.innerHTML = `
                    <div style="flex:1">
                        <div style="font-weight:bold">${i.title}</div>
                        <div style="font-size:0.8rem; opacity:0.6">${i.type==='evt' ? i.time : (i.type==='task'?'AttivitÃ ':'Transazione')}</div>
                    </div>
                    ${i.type==='task' ? `<i class="fas fa-${i.done?'check-circle':'circle'}" onclick="toggleTaskInCal(${i.id})"></i>` : ''}
                `;
                l.appendChild(row);
            });
        }
        function toggleTaskInCal(id) { const t=db.tasks.find(x=>x.id===id); if(t){t.done=!t.done; saveDB(); renderCal();} }

        // --- FINANCE ---
        function renderFin() {
            const bal = db.finance.reduce((a,b)=>a+b.amt,0);
            document.getElementById('fin-bal-w').innerText = `â‚¬${bal.toFixed(2)}`;
            
            // Month calc
            const startM = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            const mTrans = db.finance.filter(f => new Date(f.date) >= startM);
            const mBal = mTrans.reduce((a,b)=>a+b.amt,0);
            document.getElementById('fin-month-w').innerText = `${mBal>0?'+':''}â‚¬${mBal}`;

            const list = document.getElementById('fin-list');
            list.innerHTML = '';
            // History
            db.finance.slice().sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(f => {
                const d = document.createElement('div');
                d.style.display='flex'; d.style.justifyContent='space-between'; d.style.padding='15px'; d.style.borderBottom='1px solid #eee';
                d.innerHTML = `
                    <div><b>${f.desc}</b><div style="font-size:0.8rem; color:grey">${f.date} ${f.recurType!=='none'?'ðŸ”„':''}</div></div>
                    <div style="font-weight:bold; color:${f.amt>0?'var(--col-fin)':'var(--col-task)'}">${f.amt}â‚¬</div>
                `;
                list.appendChild(d);
            });

            // Charts
            renderFinCharts();
        }

        function renderFinCharts() {
            const ctxB = document.getElementById('finBarChart').getContext('2d');
            const ctxL = document.getElementById('finLineChart').getContext('2d');
            if(charts.fb) charts.fb.destroy();
            if(charts.fl) charts.fl.destroy();

            // Bar (Inc vs Exp)
            const inc = db.finance.filter(f=>f.amt>0).reduce((a,b)=>a+b.amt,0);
            const exp = Math.abs(db.finance.filter(f=>f.amt<0).reduce((a,b)=>a+b.amt,0));
            charts.fb = new Chart(ctxB, {
                type:'bar', data:{labels:['Entrate','Uscite'], datasets:[{data:[inc,exp], backgroundColor:['#10b981','#ef4444']}]},
                options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
            });

            // Line (Trend)
            let r=0;
            const data = db.finance.slice(-20).map(f=>{r+=f.amt; return r;});
            charts.fl = new Chart(ctxL, {
                type:'line', data:{labels:data.map((_,i)=>i), datasets:[{data:data, borderColor:'#3b82f6', tension:0.4}]},
                options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}}}
            });
        }

        // --- TASK ---
        function renderTodo() {
            const c = document.getElementById('todo-container');
            c.innerHTML = '';
            db.lists.forEach(l => {
                const ts = db.tasks.filter(t=>t.listId===l.id);
                const d = ts.filter(t=>t.done).length;
                const p = ts.length===0?0:(d/ts.length)*100;
                
                const box = document.createElement('div');
                box.className = 'widget'; box.style.borderLeft = `5px solid ${l.col}`;
                box.innerHTML = `
                    <div class="widget-head"><span>${l.name}</span> <span>${d}/${ts.length}</span></div>
                    <div style="height:5px; background:#eee; border-radius:3px; margin-bottom:10px"><div style="height:100%; width:${p}%; background:${l.col}"></div></div>
                `;
                ts.forEach(t => {
                    box.innerHTML += `
                        <div style="display:flex; align-items:center; padding:10px 0; border-top:1px solid #eee">
                            <i class="fas fa-${t.done?'check-circle':'circle'}" style="color:${t.done?l.col:'#ccc'}; font-size:1.2rem; cursor:pointer" onclick="togTask(${t.id})"></i>
                            <span style="margin-left:10px; flex:1; text-decoration:${t.done?'line-through':''}">${t.title}</span>
                            <i class="fas fa-trash" style="opacity:0.3; cursor:pointer" onclick="delTask(${t.id})"></i>
                        </div>
                    `;
                });
                c.appendChild(box);
            });
        }
        function togTask(id) { const t=db.tasks.find(x=>x.id===id); t.done=!t.done; saveDB(); renderTodo(); }
        function delTask(id) { db.tasks=db.tasks.filter(x=>x.id!==id); saveDB(); renderTodo(); }

        // --- MANUAL SAVE LOGIC ---
        // Helper to get selected values from multi-select buttons
        function getVals(pid) {
            const vals = [];
            document.querySelectorAll(`#${pid} .ms-btn.active`).forEach(b => {
                // Determine index from onclick attribute... hacky but works for single file
                // Better: rely on loop index logic in HTML generation or data attr
                // I used onclick="togBtn(this, X)". Let's parse it or rely on order.
                // Let's assume order is consistent with rendering.
                // Re-implementation: Let's use data attributes for robustness.
            });
            // Actually, let's just re-read the onclick attr since it's hardcoded
            const btns = document.querySelectorAll(`#${pid} .ms-btn`);
            btns.forEach((b, i) => {
                if(b.classList.contains('active')) {
                    // Extract value passed to toggle function
                    const val = parseInt(b.getAttribute('onclick').match(/\d+/)[0]);
                    vals.push(val);
                }
            });
            return vals;
        }

        function togBtn(b) { b.classList.toggle('active'); }
        function toggleRecurOptions(type, val) {
            // Hide all
            if(document.getElementById(`${type}-days`)) document.getElementById(`${type}-days`).style.display='none';
            if(document.getElementById(`${type}-months`)) document.getElementById(`${type}-months`).style.display='none';
            
            if(val === 'weekly') document.getElementById(`${type}-days`).style.display='flex';
            if(val === 'monthly' && type === 'evt') document.getElementById(`${type}-months`).style.display='flex'; // Actually usually monthly is day of month, but request said "select months"
            if(val === 'custom_months' || (type==='evt' && val==='monthly')) document.getElementById(`${type}-months`).style.display='flex';
        }

        function saveEvt() {
            const t=document.getElementById('evt-title').value;
            const d=document.getElementById('evt-date').value;
            const s=document.getElementById('evt-start').value;
            const e=document.getElementById('evt-end').value;
            const r=document.getElementById('evt-recur').value;
            const days = getVals('evt-days');
            const months = getVals('evt-months');

            if(t&&d) {
                db.events.push({id:Date.now(), title:t, date:d, start:s, end:e, recurType:r, recurVals: r==='weekly'?days:months});
                saveDB(); closeModal(null,'modal-evt'); renderCal();
            }
        }

        function saveFin() {
            const desc = document.getElementById('fin-desc').value;
            const amt = parseFloat(document.getElementById('fin-amt').value);
            const d = document.getElementById('fin-date').value;
            const r = document.getElementById('fin-recur').value;
            const months = getVals('fin-months');

            if(desc && amt) {
                db.finance.push({id:Date.now(), desc, amt, date:d, recurType:r, recurVals:months});
                saveDB(); closeModal(null,'modal-fin'); renderFin();
            }
        }

        function saveList() {
            const n = document.getElementById('list-name').value;
            const c = document.getElementById('list-col').value;
            if(n) { db.lists.push({id:Date.now(), name:n, col:c}); saveDB(); closeModal(null,'modal-list'); renderTodo(); updateTaskSelect(); }
        }

        function saveTask() {
            const t = document.getElementById('task-title').value;
            const l = document.getElementById('task-list-sel').value;
            const d = document.getElementById('task-date').value;
            const r = document.getElementById('task-recur').value;
            const days = getVals('task-days');

            if(t && l) {
                db.tasks.push({id:Date.now(), title:t, listId:l, date:d, done:false, recurType:r, recurVals:days});
                saveDB(); closeModal(null,'modal-task'); renderTodo();
            }
        }

        function updateTaskSelect() {
            const s = document.getElementById('task-list-sel');
            s.innerHTML = '';
            db.lists.forEach(l => {
                s.innerHTML += `<option value="${l.id}">${l.name}</option>`;
            });
        }

        // --- UI UTILS ---
        function toggleTheme() {
            db.settings.theme = db.settings.theme==='light'?'dark':'light';
            document.body.setAttribute('data-theme', db.settings.theme);
            saveDB();
        }
        function openModal(id) { 
            if(id === 'modal-task') updateTaskSelect();
            document.getElementById(id).style.display='flex'; 
        }
        function closeModal(e, id) { if(!e||e.target.id===id) document.getElementById(id).style.display='none'; }
        
        function saveSet() {
            db.settings.name = document.getElementById('user-name').value;
            db.settings.aiKey = document.getElementById('user-key').value;
            saveDB();
        }
        
        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            a.download = "MyDavide_Backup.json"; a.click();
        }
        function importData(el) {
            const fr = new FileReader();
            fr.onload = e => { db=JSON.parse(e.target.result); saveDB(); location.reload(); };
            fr.readAsText(el.files[0]);
        }
        function resetApp() { if(confirm("Cancellare tutto?")) { localStorage.removeItem('MyDavide8'); location.reload(); } }

    </script>
</body>
</html>